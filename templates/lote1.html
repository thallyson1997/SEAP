<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lote 1 - Empresa Alpha</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/lote.css') }}">
</head>
<body>

    <!-- Topo da página: botão voltar à esquerda e filtro de mês/ano à direita -->
    <div class="top-bar-seap">
        <a href="/?mes={{ mes }}&ano={{ ano }}" class="voltar">&larr; Voltar</a>
        <form id="filtro-form" method="get">
            <label for="mes" style="margin:0;">Mês:</label>
            <select name="mes" id="mes">
                {% set meses_nomes = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'] %}
                {% for m in meses %}
                    <option value="{{ m }}" {% if m == mes %}selected{% endif %}>{{ meses_nomes[m-1] }}</option>
                {% endfor %}
            </select>
            <label for="ano" style="margin:0;">Ano:</label>
            <select name="ano" id="ano">
                <option value="2025" selected>2025</option>
            </select>
            <button type="submit" style="padding:2px 10px; font-size:0.98rem;">Filtrar</button>
        </form>
    </div>

    <div class="lote-header">
        <h1>Lote 1 - Empresa Alpha</h1>
        <p>Contrato nº 2025/001 | Portaria 1234/2025</p>
    </div>

    <!-- Botões de ação acima do filtro e tabela -->
    <div class="actions">
        <button id="btnAdd" type="button">Adicionar/Editar Dados</button>
        <button id="btnDelete" type="button">Excluir Dados</button>
    </div>
    <!-- Filtro de tabela e tabela renderizada -->
    <div class="dados-container">
        {% if tabela_unica_html %}
            <div class="filtros-popup-bar" style="gap: 10px;">
                <button id="abrir-filtro-presidio" type="button">Filtrar Presídio</button>
                <button id="abrir-filtro-data" type="button">Filtrar Data</button>
                <button id="aplicar-filtros" type="button" style="background:#007bff;color:#fff;">Filtrar</button>
                <button id="limpar-filtros" type="button" style="background:#e0e0e0;color:#333;">Limpar seleção</button>
            </div>
            <!-- Popup filtro presídio -->
            <div id="popup-filtro-presidio" class="popup-filtros">
                <div class="popup-filtros-content">
                    <button type="button" class="popup-close" id="close-popup-presidio">×</button>
                    <h3>Selecione o(s) Presídio(s)</h3>
                    <div class="filtros-opcoes" id="filtros-presidio-opcoes"></div>
                </div>
            </div>
            <!-- Popup filtro data -->
            <div id="popup-filtro-data" class="popup-filtros">
                <div class="popup-filtros-content">
                    <button type="button" class="popup-close" id="close-popup-data">×</button>
                    <h3>Selecione a(s) Data(s)</h3>
                    <div class="filtros-opcoes" id="filtros-data-opcoes"></div>
                </div>
            </div>
            <div class="tabela-renderizada" style="width:100%;max-width:none;">
                {{ tabela_unica_html|safe }}
            </div>
        {% elif not dados %}
            <p>Nenhum dado adicionado ainda.</p>
        {% endif %}
    </div>

    <!-- Popup Adicionar/Editar -->
    <div id="popup" class="popup">
        <form method="POST" class="popup-content">
            <input type="hidden" name="acao" value="adicionar_editar">
            <input type="hidden" name="mes" id="mes_hidden" value="{{ mes }}">
            <input type="hidden" name="ano" id="ano_hidden" value="{{ ano }}">
            <h2>Adicionar/Editar Dados</h2>
            {% if erro %}
                <div class="erro-popup" style="color: #b30000; background: #ffeaea; padding: 8px 10px; border-radius: 6px; margin-bottom: 10px; text-align: center;">{{ erro }}</div>
            {% endif %}
            <label for="presidio">Selecione o Presídio:</label>
            <select name="presidio" id="presidio" required>
                <option value="">Selecione...</option>
                <option value="Presídio Central">Presídio Central</option>
                <option value="Penitenciária Alfa">Penitenciária Alfa</option>
                <option value="Colônia Beta">Colônia Beta</option>
            </select>



            <label for="texto">Observação (opcional):</label>
            <textarea name="texto" id="texto"></textarea>
            <textarea name="tabela" id="tabela" placeholder="Cole aqui a tabela extraída do PDF..." required></textarea>

            <div class="popup-buttons">
                <button type="submit">Salvar</button>
                <button type="button" id="btnClose">Cancelar</button>
            </div>
        </form>
    </div>

    <!-- Popup Excluir -->
    <div id="popupDelete" class="popup">
        <form method="POST" class="popup-content">
            <input type="hidden" name="acao" value="excluir">
            <h2>Excluir Dados</h2>
            <label for="presidio_excluir">Selecione o Presídio:</label>
            <select name="presidio_excluir" id="presidio_excluir" required>
                <option value="">Selecione...</option>
                <option value="Presídio Central">Presídio Central</option>
                <option value="Penitenciária Alfa">Penitenciária Alfa</option>
                <option value="Colônia Beta">Colônia Beta</option>
            </select>
            <div class="popup-buttons">
                <button type="submit" style="background:#b30000;">Excluir</button>
                <button type="button" id="btnCloseDelete">Cancelar</button>
            </div>
        </form>
    </div>

    <!-- Removido bloco duplicado de tabela/dados -->

    <script id="dados-json" type="application/json">{{ dados|tojson|safe }}</script>
    <script>

        // Filtro popup separado para presídio e data
        function criarFiltroPopupSeparado() {
            const tabela = document.querySelector('.tabela-renderizada table');
            if (!tabela) return;
            const linhas = Array.from(tabela.querySelectorAll('tbody tr'));
            const colPresidio = Array.from(tabela.querySelectorAll('thead th')).findIndex(th => th.textContent.trim() === 'Presídio');
            const colData = Array.from(tabela.querySelectorAll('thead th')).findIndex(th => th.textContent.trim() === 'Data');
            const presidios = [...new Set(linhas.map(tr => tr.children[colPresidio]?.textContent.trim()))].filter(Boolean);
            const datas = [...new Set(linhas.map(tr => tr.children[colData]?.textContent.trim()))].filter(Boolean);

            // Elementos dos popups
            const btnAbrirPresidio = document.getElementById('abrir-filtro-presidio');
            const btnAbrirData = document.getElementById('abrir-filtro-data');
            const popupPresidio = document.getElementById('popup-filtro-presidio');
            const popupData = document.getElementById('popup-filtro-data');
            const opcoesPresidio = document.getElementById('filtros-presidio-opcoes');
            const opcoesData = document.getElementById('filtros-data-opcoes');
            const btnLimpar = document.getElementById('limpar-filtros');
            const btnFiltrar = document.getElementById('aplicar-filtros');
            // const resumoFiltros = document.getElementById('resumo-filtros');

            // Preencher opções
            function criarCheckboxes(lista, container, grupo) {
                container.innerHTML = '';
                lista.forEach(valor => {
                    const id = `chk-${grupo}-${valor.replace(/\W/g,'_')}`;
                    const label = document.createElement('label');
                    label.className = 'chk-label';
                    const chk = document.createElement('input');
                    chk.type = 'checkbox';
                    chk.value = valor;
                    chk.id = id;
                    label.appendChild(chk);
                    label.appendChild(document.createTextNode(' ' + valor));
                    container.appendChild(label);
                });
            }
            criarCheckboxes(presidios, opcoesPresidio, 'presidio');
            criarCheckboxes(datas, opcoesData, 'data');

            // Estado dos filtros
            let selecionadosPresidio = [];
            let selecionadosData = [];

            // Abrir/fechar popups
            btnAbrirPresidio.onclick = () => {
                popupPresidio.style.display = 'flex';
                opcoesPresidio.querySelectorAll('input[type=checkbox]').forEach(chk => {
                    chk.checked = selecionadosPresidio.includes(chk.value);
                });
            };
            btnAbrirData.onclick = () => {
                popupData.style.display = 'flex';
                opcoesData.querySelectorAll('input[type=checkbox]').forEach(chk => {
                    chk.checked = selecionadosData.includes(chk.value);
                });
            };
            popupPresidio.onclick = e => { if (e.target === popupPresidio) popupPresidio.style.display = 'none'; };
            popupData.onclick = e => { if (e.target === popupData) popupData.style.display = 'none'; };
            document.getElementById('close-popup-presidio').onclick = () => { popupPresidio.style.display = 'none'; };
            document.getElementById('close-popup-data').onclick = () => { popupData.style.display = 'none'; };

            // Seleção dos checkboxes
            opcoesPresidio.onclick = () => {
                selecionadosPresidio = Array.from(opcoesPresidio.querySelectorAll('input[type=checkbox]:checked')).map(chk => chk.value);
            };
            opcoesData.onclick = () => {
                selecionadosData = Array.from(opcoesData.querySelectorAll('input[type=checkbox]:checked')).map(chk => chk.value);
            };

            // Limpar filtros
            btnLimpar.onclick = () => {
                selecionadosPresidio = [];
                selecionadosData = [];
                opcoesPresidio.querySelectorAll('input[type=checkbox]').forEach(chk => chk.checked = false);
                opcoesData.querySelectorAll('input[type=checkbox]').forEach(chk => chk.checked = false);
                linhas.forEach(tr => tr.style.display = '');
            };

            // Aplicar filtros
            btnFiltrar.onclick = () => {
                selecionadosPresidio = Array.from(opcoesPresidio.querySelectorAll('input[type=checkbox]:checked')).map(chk => chk.value);
                selecionadosData = Array.from(opcoesData.querySelectorAll('input[type=checkbox]:checked')).map(chk => chk.value);
                linhas.forEach(tr => {
                    const pres = tr.children[colPresidio]?.textContent.trim();
                    const data = tr.children[colData]?.textContent.trim();
                    const matchPres = selecionadosPresidio.length === 0 || selecionadosPresidio.includes(pres);
                    const matchData = selecionadosData.length === 0 || selecionadosData.includes(data);
                    tr.style.display = (matchPres && matchData) ? '' : 'none';
                });
            };
        }
        document.addEventListener('DOMContentLoaded', criarFiltroPopupSeparado);

        // Adicionar/Editar Dados
        const popup = document.getElementById('popup');
        document.getElementById('btnAdd').onclick = () => {
            document.getElementById('presidio').value = '';
            document.getElementById('texto').value = '';
            popup.classList.add('ativo');
        };
        document.getElementById('btnClose').onclick = () => popup.classList.remove('ativo');
        popup.addEventListener('click', function(e) {
            if (e.target === popup) popup.classList.remove('ativo');
        });

        // Atualiza os campos ocultos de mês/ano do formulário de adicionar/editar sempre que o filtro for alterado
        document.getElementById('mes_hidden').value = document.getElementById('mes').value;
        document.getElementById('ano_hidden').value = document.getElementById('ano').value;
        document.getElementById('mes').addEventListener('change', function() {
            document.getElementById('mes_hidden').value = this.value;
        });
        document.getElementById('ano').addEventListener('change', function() {
            document.getElementById('ano_hidden').value = this.value;
        });

        // Preencher texto ao selecionar presídio para editar
        const dadosEdit = JSON.parse(document.getElementById('dados-json').textContent);
        document.getElementById('presidio').onchange = function() {
            const pres = this.value;
            const item = dadosEdit.find(d => d.presidio === pres);
            document.getElementById('texto').value = item ? item.texto : '';
        };

        // Excluir Dados
        const popupDelete = document.getElementById('popupDelete');
        document.getElementById('btnDelete').onclick = () => {
            document.getElementById('presidio_excluir').value = '';
            popupDelete.classList.add('ativo');
        };
        document.getElementById('btnCloseDelete').onclick = () => popupDelete.classList.remove('ativo');
        popupDelete.addEventListener('click', function(e) {
            if (e.target === popupDelete) popupDelete.classList.remove('ativo');
        });
    </script>
</body>
</html>
