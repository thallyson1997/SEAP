<!DOCTYPE html>
<html lang="pt-BR">
<head>
        <script type="text/javascript">
            window.mesAtual = {{ mes|tojson|safe }};
            window.anoAtual = {{ ano|tojson|safe }};
        </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lote 1 - Empresa Alpha</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/lote.css') }}">
</head>
<body>
    <!-- Popup Adicionar Manualmente -->
    <div id="popupManualAdd" class="popup">
    <form class="popup-content" id="formManualAdd" method="POST" action="/adicionar_manual" style="max-width:700px;min-width:400px;width:60vw;">
            <h2>Adicionar Manualmente</h2>
            <input type="hidden" name="mes" id="mes_manual_hidden" value="{{ mes }}">
            <input type="hidden" name="ano" id="ano_manual_hidden" value="{{ ano }}">
            <label for="presidioManualAdd">Selecione o Presídio:</label>
                <select name="presidioManualAdd" id="presidioManualAdd" required>
                    <option value="">Selecione...</option>
                    {% for p in presidios %}
                    <option value="{{ p }}">{{ p }}</option>
                    {% endfor %}
                </select>
            <div id="conteudoManualAdd" style="margin-top:16px;"></div>
            {% set colunas = [
                'Café Interno', 'Café Funcionário',
                'Almoço Interno', 'Almoço Funcionário',
                'Lanche Interno', 'Lanche Funcionário',
                'Jantar Interno', 'Jantar Funcionário'
            ] %}
            <table id="tabelaManualInput" style="width:100%;margin:18px 0;border-collapse:collapse;">
                <thead>
                    <tr>
                        <th style="padding:0;">Dia</th>
                        {% for col in colunas %}
                        <th style="padding:0;">{{ col }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for dia in range(1, dias_no_mes + 1) %}
                    <tr>
                        <td style="padding:0;">
                            <input type="text" name="dia_{{ dia }}" value="{{ dia }}" style="width:40px;padding:1px 2px;font-size:0.92em;height:12px;line-height:16px;" />
                        </td>
                        {% for col in colunas %}
                        <td style="padding:0;">
                            <input type="text" name="{{ col }}_{{ dia }}" style="width:60%;padding:1px 2px;font-size:0.92em;height:12px;line-height:16px;" />
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <style>
            #tabelaManualInput {
                border-collapse: collapse !important;
            }
            #tabelaManualInput td, #tabelaManualInput th {
                padding: 0 !important;
            }
            </style>
            </table>
            <div class="popup-buttons">
                <button type="submit" id="btnSalvarManualAdd">Salvar</button>
                <button type="button" id="btnCloseManualAdd">Cancelar</button>
            </div>
        </form>
    </div>

    <!-- Topo da página: botão voltar à esquerda e filtro de mês/ano à direita -->
    <div class="top-bar-seap">
        <a href="/?mes={{ mes }}&ano={{ ano }}" class="voltar">&larr; Voltar</a>
        <form id="filtro-form" method="get">
            <label for="mes" style="margin:0;">Mês:</label>
            <select name="mes" id="mes">
                {% set meses_nomes = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'] %}
                {% for m in meses %}
                    <option value="{{ m }}" {% if m == mes %}selected{% endif %}>{{ meses_nomes[m-1] }}</option>
                {% endfor %}
            </select>
            <label for="ano" style="margin:0;">Ano:</label>
            <select name="ano" id="ano">
                <option value="2025" selected>2025</option>
            </select>
            <button type="submit" style="padding:2px 10px; font-size:0.98rem;">Filtrar</button>
        </form>
    </div>

    <div class="lote-header">
        <h1>Lote 1 - Empresa Alpha</h1>
        <p>Contrato nº 2025/001 | Portaria 1234/2025</p>
    </div>

    <!-- Botões de ação acima do filtro e tabela -->
    <div class="actions">
        <button id="btnAdd" type="button">Adicionar Mapas</button>
        <button id="btnAddManual" type="button">Adicionar Manualmente</button>
        <button id="btnDelete" type="button">Excluir Mapas</button>
        <button id="btnAddSiisp" type="button">Adicionar n° SIISP</button>
    </div>

    <!-- Popup Adicionar SIISP -->
    <div id="popupSiisp" class="popup">
        <form method="POST" class="popup-content">
            <h2>Adicionar n° SIISP</h2>
            <label for="siisp_presidio">Presídio:</label>
            <select id="siisp_presidio" name="siisp_presidio">
                <option value="">Selecione...</option>
                {% for p in presidios %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
            </select>
            <label for="siisp_texto">Números SIISP:</label>
            <textarea id="siisp_texto" name="siisp_texto" placeholder="Digite os números SIISP..."></textarea>
            <div class="popup-buttons">
                <button type="submit">Salvar</button>
                <button type="button" id="btnCloseSiisp">Cancelar</button>
            </div>
        </form>
    </div>
    <script>
    // Colagem inteligente na tabela do popup Adicionar Manualmente
    document.addEventListener('DOMContentLoaded', function() {
        const tabela = document.getElementById('tabelaManualInput');
        if (!tabela) return;
        tabela.addEventListener('paste', function(e) {
            const target = e.target;
            if (target.tagName !== 'INPUT') return;
            e.preventDefault();
            const clipboard = e.clipboardData || window.clipboardData;
            const texto = clipboard.getData('text');
            // Divide por linhas e colunas (tab/enter)
            const linhas = texto.split(/\r?\n/).filter(l => l.length > 0);
            const celulas = linhas.map(l => l.split(/\t|;/));
            // Descobre posição inicial
            let td = target.parentElement;
            let tr = td.parentElement;
            const rowIndex = Array.from(tabela.tBodies[0].rows).indexOf(tr);
            const colIndex = Array.from(tr.cells).indexOf(td);
            // Preenche os inputs
            for (let i = 0; i < celulas.length; i++) {
                const linha = tabela.tBodies[0].rows[rowIndex + i];
                if (!linha) break;
                for (let j = 0; j < celulas[i].length; j++) {
                    const cell = linha.cells[colIndex + j];
                    if (!cell) break;
                    const input = cell.querySelector('input');
                    if (input) input.value = celulas[i][j];
                }
            }
        }, true);

        // Submete o formulário manual corretamente
        const formManualAdd = document.getElementById('formManualAdd');
        if (formManualAdd) {
            formManualAdd.onsubmit = function(e) {
                // Permite submit normal (POST)
                return true;
            };
        }
    });
        // Popup Adicionar SIISP
        const btnAddSiisp = document.getElementById('btnAddSiisp');
        const popupSiisp = document.getElementById('popupSiisp');
        const btnCloseSiisp = document.getElementById('btnCloseSiisp');
        btnAddSiisp.onclick = () => {
            document.getElementById('siisp_presidio').value = '';
            document.getElementById('siisp_texto').value = '';
            popupSiisp.classList.add('ativo');
        };
        btnCloseSiisp.onclick = () => popupSiisp.classList.remove('ativo');
        popupSiisp.addEventListener('click', function(e) {
            if (e.target === popupSiisp) popupSiisp.classList.remove('ativo');
        });
    </script>
    <!-- Filtro de tabela e tabela renderizada -->
    <div class="dados-container">
        {% if tabela_unica_html %}
            <div class="filtros-popup-bar" style="gap: 10px;">
                <button id="abrir-filtro-presidio" type="button">Filtrar Presídio</button>
                <button id="abrir-filtro-data" type="button">Filtrar Data</button>
                <button id="limpar-filtros" type="button" style="background:#e0e0e0;color:#333;">Limpar seleção</button>
            </div>
            <script id="precos-json" type="application/json">{{ precos_lote1|tojson|safe }}</script>
            <div id="resumo-somas" class="resumo-somas-tabela" style="margin-bottom: 12px;"></div>
            <!-- Popup filtro presídio -->
            <div id="popup-filtro-presidio" class="popup-filtros">
                <div class="popup-filtros-content">
                    <button type="button" class="popup-close" id="close-popup-presidio">×</button>
                    <h3>Selecione o(s) Presídio(s)</h3>
                    <div class="filtros-opcoes" id="filtros-presidio-opcoes"></div>
                    <div class="popup-filtros-botoes">
                        <button id="aplicar-filtro-presidio" type="button">Filtrar</button>
                    </div>
                </div>
            </div>
            <!-- Popup filtro data -->
            <div id="popup-filtro-data" class="popup-filtros">
                <div class="popup-filtros-content">
                    <button type="button" class="popup-close" id="close-popup-data">×</button>
                    <h3>Selecione a(s) Data(s)</h3>
                    <div class="filtros-opcoes" id="filtros-data-opcoes"></div>
                    <div class="popup-filtros-botoes">
                        <button id="aplicar-filtro-data" type="button">Filtrar</button>
                    </div>
                </div>
            </div>
            <div class="tabela-renderizada" style="width:100%;max-width:none; font-size:0.76em;">
                {{ tabela_unica_html|safe }}
            </div>
        {% elif not dados %}
            <p>Nenhum dado adicionado ainda.</p>
        {% endif %}
    </div>

    <!-- Popup Adicionar/Editar -->
    <div id="popup" class="popup">
        <form method="POST" class="popup-content">
            <input type="hidden" name="acao" value="adicionar_editar">
            <input type="hidden" name="mes" id="mes_hidden" value="{{ mes }}">
            <input type="hidden" name="ano" id="ano_hidden" value="{{ ano }}">
            <h2>Adicionar/Editar Dados</h2>
            {% if erro %}
                <div class="erro-popup" style="color: #b30000; background: #ffeaea; padding: 8px 10px; border-radius: 6px; margin-bottom: 10px; text-align: center;">{{ erro }}</div>
            {% endif %}

            <label for="presidio">Selecione o Presídio:</label>
            <select name="presidio" id="presidio" required>
                <option value="">Selecione...</option>
                {% for p in presidios %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
            </select>



            <textarea name="tabela" id="tabela" placeholder="Cole aqui a tabela extraída do PDF..." required></textarea>

            <div class="popup-buttons">
                <button type="submit">Salvar</button>
                <button type="button" id="btnClose">Cancelar</button>
            </div>
        </form>
    </div>

    <!-- Popup Excluir -->
    <div id="popupDelete" class="popup">
        <form method="POST" class="popup-content">
            <input type="hidden" name="acao" value="excluir">
            <h2>Excluir Dados</h2>
            <label for="presidio_excluir">Selecione o Presídio:</label>
            <select name="presidio_excluir" id="presidio_excluir" required>
                <option value="">Selecione...</option>
                {% for p in presidios %}
                <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
            </select>
            <div class="popup-buttons">
                <button type="submit" style="background:#b30000;">Excluir</button>
                <button type="button" id="btnCloseDelete">Cancelar</button>
            </div>
        </form>
    </div>

    <!-- Removido bloco duplicado de tabela/dados -->

    <script id="dados-json" type="application/json">{{ dados|tojson|safe }}</script>
    <script>

        // Filtro popup separado para presídio e data, com botão Filtrar dentro de cada popup
        function criarFiltroPopupSeparado() {
            const tabela = document.querySelector('.tabela-renderizada table');
            if (!tabela) return;
            const linhas = Array.from(tabela.querySelectorAll('tbody tr'));
            const colPresidio = Array.from(tabela.querySelectorAll('thead th')).findIndex(th => th.textContent.trim() === 'Presídio');
            const colData = Array.from(tabela.querySelectorAll('thead th')).findIndex(th => th.textContent.trim() === 'Data');
            const presidios = [...new Set(linhas.map(tr => tr.children[colPresidio]?.textContent.trim()))].filter(Boolean);
            const datas = [...new Set(linhas.map(tr => tr.children[colData]?.textContent.trim()))].filter(Boolean);

            // Elementos dos popups
            const btnAbrirPresidio = document.getElementById('abrir-filtro-presidio');
            const btnAbrirData = document.getElementById('abrir-filtro-data');
            const popupPresidio = document.getElementById('popup-filtro-presidio');
            const popupData = document.getElementById('popup-filtro-data');
            const opcoesPresidio = document.getElementById('filtros-presidio-opcoes');
            const opcoesData = document.getElementById('filtros-data-opcoes');
            const btnLimpar = document.getElementById('limpar-filtros');
            const btnFiltrarPresidio = document.getElementById('aplicar-filtro-presidio');
            const btnFiltrarData = document.getElementById('aplicar-filtro-data');
            const resumoSomas = document.getElementById('resumo-somas');

            // Preencher opções
            function criarCheckboxes(lista, container, grupo) {
                container.innerHTML = '';
                lista.forEach(valor => {
                    const id = `chk-${grupo}-${valor.replace(/\W/g,'_')}`;
                    const label = document.createElement('label');
                    label.className = 'chk-label';
                    const chk = document.createElement('input');
                    chk.type = 'checkbox';
                    chk.value = valor;
                    chk.id = id;
                    label.appendChild(chk);
                    label.appendChild(document.createTextNode(' ' + valor));
                    container.appendChild(label);
                });
            }
            criarCheckboxes(presidios, opcoesPresidio, 'presidio');
            criarCheckboxes(datas, opcoesData, 'data');

            // Estado dos filtros
            let selecionadosPresidio = [];
            let selecionadosData = [];

            // Função para atualizar o resumo de somas em formato de tabela
            function atualizarResumoSomas() {
                const precos = JSON.parse(document.getElementById('precos-json').textContent);
                if (!resumoSomas) return;
                // Mapeamento dos nomes das colunas para os tipos
                const tipos = [
                    {col: 'Café Interno', grupo: 'Café', subtipo: 'Interno'},
                    {col: 'Café Funcionário', grupo: 'Café', subtipo: 'Funcionário'},
                    {col: 'Almoço Interno', grupo: 'Almoço', subtipo: 'Interno'},
                    {col: 'Almoço Funcionário', grupo: 'Almoço', subtipo: 'Funcionário'},
                    {col: 'Lanche Interno', grupo: 'Lanche', subtipo: 'Interno'},
                    {col: 'Lanche Funcionário', grupo: 'Lanche', subtipo: 'Funcionário'},
                    {col: 'Jantar Interno', grupo: 'Jantar', subtipo: 'Interno'},
                    {col: 'Jantar Funcionário', grupo: 'Jantar', subtipo: 'Funcionário'}
                ];
                const ths = Array.from(tabela.querySelectorAll('thead th'));
                // Descobre o índice de cada coluna relevante
                const idxs = {};
                tipos.forEach(t => {
                    idxs[t.col] = ths.findIndex(th => th.textContent.trim().toLowerCase() === t.col.toLowerCase());
                });
                const linhasVisiveis = linhas.filter(tr => tr.style.display !== 'none');
                // Soma para cada tipo
                const somas = {};
                tipos.forEach(t => {
                    let soma = 0;
                    const idx = idxs[t.col];
                    if (idx >= 0) {
                        linhasVisiveis.forEach(tr => {
                            // Corrigido: só troca vírgula por ponto, preserva ponto decimal
                            const val = tr.children[idx]?.textContent.replace(',','.').replace(/[^\d.-]/g,'');
                            const num = parseFloat(val);
                            if (!isNaN(num)) soma += num;
                        });
                    }
                    somas[t.col] = soma;
                });
                // Cálculo do desvio: soma de cada coluna "X x SIISP" multiplicada pelo respectivo preço
                let valorDesvio = 0;
                const colunasSiisp = [
                    {col: 'Café Interno x SIISP', preco: precos['Café Interno'] || 0},
                    {col: 'Café Funcionário x SIISP', preco: precos['Café Funcionário'] || 0},
                    {col: 'Almoço Interno x SIISP', preco: precos['Almoço Interno'] || 0},
                    {col: 'Almoço Funcionário x SIISP', preco: precos['Almoço Funcionário'] || 0},
                    {col: 'Lanche Interno x SIISP', preco: precos['Lanche Interno'] || 0},
                    {col: 'Lanche Funcionário x SIISP', preco: precos['Lanche Funcionário'] || 0},
                    {col: 'Jantar Interno x SIISP', preco: precos['Jantar Interno'] || 0},
                    {col: 'Jantar Funcionário x SIISP', preco: precos['Jantar Funcionário'] || 0}
                ];
                colunasSiisp.forEach(obj => {
                    const idx = ths.findIndex(th => th.textContent.trim() === obj.col);
                    if (idx === -1) return;
                    let soma = 0;
                    linhasVisiveis.forEach(tr => {
                        const val = tr.children[idx]?.textContent.replace(',','.').replace(/[^\d.-]/g,'');
                        const num = parseFloat(val);
                        if (!isNaN(num)) soma += num;
                    });
                    valorDesvio += soma * obj.preco;
                });

                // Monta a tabela resumo normalmente
                let html = '<table class="mini-resumo"><thead><tr>';
                ['Café','Almoço','Lanche','Jantar'].forEach(grupo => {
                    html += `<th colspan=2>${grupo}</th>`;
                });
                html += '</tr><tr>';
                for (let i=0;i<4;i++) html += '<th>Interno</th><th>Funcionário</th>';
                html += '</tr></thead><tbody>';
                // Primeira linha: preços
                html += '<tr>';
                let precosLinha = [];
                ['Café','Almoço','Lanche','Jantar'].forEach(grupo => {
                    let precoInt = precos[grupo+' Interno'] || 0;
                    let precoFunc = precos[grupo+' Funcionário'] || 0;
                    precosLinha.push(precoInt, precoFunc);
                    html += `<td style='font-size:0.98em;color:#007bff;'>R$ ${precoInt.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>`;
                    html += `<td style='font-size:0.98em;color:#007bff;'>R$ ${precoFunc.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>`;
                });
                html += '</tr>';
                // Segunda linha: somas
                html += '<tr>';
                let somasLinha = [];
                ['Café','Almoço','Lanche','Jantar'].forEach(grupo => {
                    let interno = somas[grupo+' Interno'] || 0;
                    let func = somas[grupo+' Funcionário'] || 0;
                    somasLinha.push(interno, func);
                    html += `<td>${interno % 1 === 0 ? interno : interno.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>`;
                    html += `<td>${func % 1 === 0 ? func : func.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>`;
                });
                html += '</tr>';
                // Terceira linha: total por tipo de refeição (interno + funcionário)
                let totaisIndividuais = [];
                for (let i = 0; i < precosLinha.length; i++) {
                    let total = precosLinha[i] * somasLinha[i];
                    totaisIndividuais.push(total);
                }
                html += '<tr>';
                let totaisPorTipo = [];
                for (let i = 0; i < totaisIndividuais.length; i += 2) {
                    let totalTipo = (totaisIndividuais[i] || 0) + (totaisIndividuais[i+1] || 0);
                    totaisPorTipo.push(totalTipo);
                    html += `<td colspan='2' style='font-size:1em;color:#b85c00;font-weight:700;background:#fffbe6;'>R$ ${totalTipo.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>`;
                }
                html += '</tr>';

                // Linha final: valor total geral + desvio ao lado
                let valorTotal = totaisPorTipo.reduce((acc, v) => acc + v, 0);
                                html += `<tr>
                                    <td colspan='5' style='font-size:1.08em;color:#fff;background:#007bff;font-weight:700;text-align:right;'>Valor Total: R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                                    <td colspan='3' style='font-size:1.08em; background:#222; font-weight:700; text-align:right;'>
                                        <span style='color:#ffe066; background:transparent; font-size:1.13em; font-weight:700; padding:8px 0 8px 0; border-radius:8px;'>Desvio: R$ ${valorDesvio.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})}</span>
                                    </td>
                                </tr>`;

                html += '</tbody></table>';
                resumoSomas.innerHTML = html;
            }

            // Abrir/fechar popups
            btnAbrirPresidio.onclick = () => {
                popupPresidio.style.display = 'flex';
                opcoesPresidio.querySelectorAll('input[type=checkbox]').forEach(chk => {
                    chk.checked = selecionadosPresidio.includes(chk.value);
                });
            };
            btnAbrirData.onclick = () => {
                popupData.style.display = 'flex';
                opcoesData.querySelectorAll('input[type=checkbox]').forEach(chk => {
                    chk.checked = selecionadosData.includes(chk.value);
                });
            };
            popupPresidio.onclick = e => { if (e.target === popupPresidio) popupPresidio.style.display = 'none'; };
            popupData.onclick = e => { if (e.target === popupData) popupData.style.display = 'none'; };
            document.getElementById('close-popup-presidio').onclick = () => { popupPresidio.style.display = 'none'; };
            document.getElementById('close-popup-data').onclick = () => { popupData.style.display = 'none'; };

            // Seleção dos checkboxes
            opcoesPresidio.onclick = () => {
                selecionadosPresidio = Array.from(opcoesPresidio.querySelectorAll('input[type=checkbox]:checked')).map(chk => chk.value);
            };
            opcoesData.onclick = () => {
                selecionadosData = Array.from(opcoesData.querySelectorAll('input[type=checkbox]:checked')).map(chk => chk.value);
            };

            // Limpar filtros
            btnLimpar.onclick = () => {
                selecionadosPresidio = [];
                selecionadosData = [];
                opcoesPresidio.querySelectorAll('input[type=checkbox]').forEach(chk => chk.checked = false);
                opcoesData.querySelectorAll('input[type=checkbox]').forEach(chk => chk.checked = false);
                linhas.forEach(tr => tr.style.display = '');
                atualizarResumoSomas();
            };

            // Aplicar filtro de presídio
            btnFiltrarPresidio.onclick = () => {
                selecionadosPresidio = Array.from(opcoesPresidio.querySelectorAll('input[type=checkbox]:checked')).map(chk => chk.value);
                linhas.forEach(tr => {
                    const pres = tr.children[colPresidio]?.textContent.trim();
                    const data = tr.children[colData]?.textContent.trim();
                    const matchPres = selecionadosPresidio.length === 0 || selecionadosPresidio.includes(pres);
                    const matchData = selecionadosData.length === 0 || selecionadosData.includes(data);
                    tr.style.display = (matchPres && matchData) ? '' : 'none';
                });
                atualizarResumoSomas();
                popupPresidio.style.display = 'none';
            };
            // Aplicar filtro de data
            btnFiltrarData.onclick = () => {
                selecionadosData = Array.from(opcoesData.querySelectorAll('input[type=checkbox]:checked')).map(chk => chk.value);
                linhas.forEach(tr => {
                    const pres = tr.children[colPresidio]?.textContent.trim();
                    const data = tr.children[colData]?.textContent.trim();
                    const matchPres = selecionadosPresidio.length === 0 || selecionadosPresidio.includes(pres);
                    const matchData = selecionadosData.length === 0 || selecionadosData.includes(data);
                    tr.style.display = (matchPres && matchData) ? '' : 'none';
                });
                atualizarResumoSomas();
                popupData.style.display = 'none';
            };

            // Inicializa o resumo ao carregar
            atualizarResumoSomas();
        }
        document.addEventListener('DOMContentLoaded', criarFiltroPopupSeparado);

        // Marcação persistente de célula amarela
        document.addEventListener('DOMContentLoaded', function() {
            const tabela = document.querySelector('.tabela-renderizada table');
            if (!tabela) return;
            tabela.addEventListener('dblclick', function(e) {
                let td = e.target;
                if (td.tagName !== 'TD') return;
                // Descobre linha e coluna da célula (tbody apenas)
                const tr = td.parentElement;
                const tbody = tabela.querySelector('tbody');
                const trs = Array.from(tbody.children).filter(el => el.tagName === 'TR');
                const rowIdx = trs.indexOf(tr);
                const colIdx = Array.from(tr.children).indexOf(td);
                // Descobre se coluna é x SIISP
                const ths = tabela.querySelectorAll('thead th');
                const colName = ths[colIdx]?.textContent.trim().toLowerCase();
                if (colName && colName.endsWith('x siisp')) {
                    // Não permite anotação persistente nessas colunas
                    return;
                }
                // Descobre presídio
                let idxPresidio = -1;
                ths.forEach((th, i) => {
                    if (th.textContent.trim().toLowerCase() === 'presídio') idxPresidio = i;
                });
                let presidio = '';
                if (idxPresidio >= 0) {
                    presidio = tr.children[idxPresidio]?.textContent.trim();
                }
                const mes = window.mesAtual;
                const ano = window.anoAtual;
                fetch('/anotar_celula', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ presidio, mes, ano, linha: rowIdx, coluna: colIdx })
                })
                .then(resp => resp.json())
                .then(data => {
                    if (data.ok) {
                        if (data.marcado) {
                            td.classList.add('celula-anotada');
                        } else {
                            td.classList.remove('celula-anotada');
                        }
                    } else {
                        alert('Erro ao anotar célula: ' + (data.msg || ''));
                    }
                })
                .catch(() => alert('Erro de comunicação com o servidor.'));
            });
        });

        // Adicionar/Editar Dados

        const popup = document.getElementById('popup');
        document.getElementById('btnAdd').onclick = () => {
            document.getElementById('presidio').value = '';
            popup.classList.add('ativo');
        };
        document.getElementById('btnClose').onclick = () => popup.classList.remove('ativo');
        popup.addEventListener('click', function(e) {
            if (e.target === popup) popup.classList.remove('ativo');
        });

        // Atualiza os campos ocultos de mês/ano do formulário de adicionar/editar sempre que o filtro for alterado
        document.getElementById('mes_hidden').value = document.getElementById('mes').value;
        document.getElementById('ano_hidden').value = document.getElementById('ano').value;
        document.getElementById('mes').addEventListener('change', function() {
            document.getElementById('mes_hidden').value = this.value;
        });
        document.getElementById('ano').addEventListener('change', function() {
            document.getElementById('ano_hidden').value = this.value;
        });

        // Excluir Dados
        const popupDelete = document.getElementById('popupDelete');
        document.getElementById('btnDelete').onclick = () => {
            document.getElementById('presidio_excluir').value = '';
            popupDelete.classList.add('ativo');
        };
        document.getElementById('btnCloseDelete').onclick = () => popupDelete.classList.remove('ativo');
        popupDelete.addEventListener('click', function(e) {
            if (e.target === popupDelete) popupDelete.classList.remove('ativo');
        });
    </script>
</body>
    <script>
    // Popup Adicionar Manualmente (padrão igual aos outros)
    const popupManualAdd = document.getElementById('popupManualAdd');
    document.getElementById('btnAddManual').onclick = () => {
        popupManualAdd.classList.add('ativo');
    };
    document.getElementById('btnCloseManualAdd').onclick = () => popupManualAdd.classList.remove('ativo');
    popupManualAdd.addEventListener('click', function(e) {
        if (e.target === popupManualAdd) popupManualAdd.classList.remove('ativo');
    });
    </script>
</html>
